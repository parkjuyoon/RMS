<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.ktds.manager.login.mapper.RuleEditorMapper">

	<select id="getFactorGrpList" resultType="java.util.HashMap">
		SELECT
			FACTOR_GRP_ID,
			FACTOR_GRP_NM,
		    FACTOR_GRP_DSC,
		    REG_DTM,
		    ATTR_USE_YN
		FROM
		    targetai.FACTOR_GRP
		WHERE
			ATTR_USE_YN = 'Y'
	</select>
	
	<select id="getFactorList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			FACTOR_ID,
		    FACTOR_NM,
		    FACTOR_NM_EN,
		    FACTOR_TYPE,
		    DATA_TYPE,
		    NUM_OF_GRP,
		    CATEGORY_YN,
		    FACTOR_GRP_ID,
		    ATTR_USE_YN
		FROM
		    targetai.FACTOR
		WHERE
			ATTR_USE_YN = 'Y'
			AND FACTOR_GRP_ID = #{factor_grp_id};
	</select>
	
	<select id="getFactor" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			FG.FACTOR_GRP_ID,
		    FG.FACTOR_GRP_NM,
		    F.FACTOR_ID,
		    F.FACTOR_NM,
		    F.FACTOR_NM_EN,
		    F.FACTOR_TYPE,
		    F.DATA_TYPE,
		    F.ATTR_USE_YN
		FROM
		    targetai.FACTOR F, targetai.FACTOR_GRP FG
		WHERE
			F.FACTOR_GRP_ID = FG.FACTOR_GRP_ID
		    AND F.ATTR_USE_YN = 'Y'
		    AND F.FACTOR_ID = #{factor_id}
	</select>
	
	<select id="getFactorVal" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			FG.FACTOR_GRP_ID,
		    FG.FACTOR_GRP_NM,
		    F.FACTOR_ID,
		    F.FACTOR_NM,
		    F.FACTOR_NM_EN,
		    F.FACTOR_TYPE,
		    F.DATA_TYPE,
		    F.ATTR_USE_YN,
		    FV.VAL
		FROM
		    targetai.FACTOR F, targetai.FACTOR_GRP FG, targetai.FACTOR_VAL FV
		WHERE
			F.FACTOR_GRP_ID = FG.FACTOR_GRP_ID
		    AND F.FACTOR_ID = FV.FACTOR_ID
		    AND F.ATTR_USE_YN = 'Y'
		    AND F.DATA_TYPE = 'STRING'
		    AND F.FACTOR_ID = #{factor_id}
	</select>
	
	<!-- RULE 이름 중복체크 -->
	<select id="getRuleNameCheck" parameterType="java.util.HashMap" resultType="int">
		SELECT 
		    COUNT(*)
		FROM
		    targetai.PKG P, targetai.RULE R
		WHERE
			P.PKG_ID = R.PKG_ID
			AND P.PKG_ID = #{PKG_ID}
		    AND R.RULE_NM = #{RULE_NM}
	</select>
	
	<!-- RULE 저장 -->
	<insert id="insertRuleInfo" parameterType="java.util.HashMap">
		INSERT INTO targetai.RULE
		(
			RULE_NM,
			NO_LOOP,
			LOCK_ON_ACTIVE,
			SALIENCE,
			ATTR_THEN,
			PKG_ID
		)
		VALUES 
		(
			#{RULE_NM},
			#{NO_LOOP},
			#{LOCK_ON_ACTIVE},
			#{SALIENCE},
			#{ATTR_THEN},
			#{PKG_ID}
		)
		<selectKey keyProperty="RULE_ID" keyColumn="SEQ" resultType="Integer" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<!-- RULE 속성 저장 -->
	<insert id="insertRuleAttr" parameterType="java.util.HashMap">
		INSERT INTO targetai.RULE_ATTR
		(
			RULE_ID,
			ATTR_WHEN,
			FUNC_YN
		) VALUES 
		<foreach collection="ATTR_WHEN_LIST" item="ATTR_WHEN" separator=",">
		(
			#{RULE_ID},
			#{ATTR_WHEN},
			#{FUNC_YN}
		)
		</foreach>
	</insert>

	<!-- PKG 정보 조회 -->
	<select id="getPkgById" parameterType="String" resultType="java.util.HashMap">
		SELECT
			PKG_ID,
		    PKG_NM,
		    DRL_NM,
		    DRL_SOURCE,
		    DIALECT,
		    PATH
		FROM
			targetai.PKG
		WHERE
			PKG_ID = #{pkgId}
	</select>
	
	<!-- RULE 정보 조회 -->
	<select id="getRuleList" parameterType="String" resultType="java.util.HashMap">
		SELECT
			RULE_ID,
		    RULE_NM,
		    NO_LOOP,
		    LOCK_ON_ACTIVE,
		    AGENDA_GRP,
		    SALIENCE,
		    EFFECTIVE_DT,
		    EXPIRES_DT,
		    ENABLED,
		    DURATION,
		    ATTR_THEN,
		    NUM_OF_TGT,
		    PKG_ID,
		    CAP_ID,
		    REG_DT
		FROM
			targetai.RULE
		WHERE
			PKG_ID = #{pkgId}
	</select>
	
	<!-- RULE_ATTR 정보 조회 -->
	<select id="getWhenList" parameterType="Integer" resultType="java.util.HashMap">
		SELECT
			RULE_ATTR_ID,
		    RULE_ID,
		    ATTR_WHEN,
		    FUNC_YN,
		    FUNC_URL,
		    FUNC_PARAM,
		    FUNC_LOGICAL,
		    FUNC_VAL,
		    REG_DTM,
		    REG_USRID
		FROM
			targetai.RULE_ATTR
		WHERE
			RULE_ID = #{pkgId}
		ORDER BY 
			RULE_ATTR_ID ASC
	</select>
	
	<!-- PKG 의 DRL_SOURCE 업데이트 -->
	<update id="updateDrlSource" parameterType="java.util.HashMap">
		UPDATE targetai.PKG
		SET
			DRL_SOURCE = #{DRL_SOURCE}
		WHERE
			PKG_ID = #{PKG_ID}
	</update>
	
</mapper>