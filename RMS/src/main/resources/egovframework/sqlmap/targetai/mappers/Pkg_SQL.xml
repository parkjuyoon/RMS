<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.ktds.targetai.mapper.PkgMapper">

	<!-- package 리스트 조회 -->
	<select id="getPkgList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
			P.PKG_ID,
		    P.PKG_NM,
		    P.DRL_NM,
		    P.DRL_SOURCE,
		    P.DIALECT,
		    P.PATH,
		    P.REG_USRID,
		    M.MEMBER_NAME REG_USRNM,
		    DATE_FORMAT(P.REG_DT, '%Y-%m-%d %h:%i:%s') AS REG_DT,
		    PKG_DSC,
		    DATE_FORMAT(P.UDT_DT, '%Y-%m-%d %h:%i:%s') AS UDT_DT,
		    P.UDT_USRID,
		    M1.MEMBER_NAME UDT_USRNM
		FROM 
			targetai.PKG P
			LEFT JOIN targetai.MEMBER M ON (P.REG_USRID = M.MEMBER_ID)
		    LEFT JOIN targetai.MEMBER M1 ON (P.UDT_USRID = M1.MEMBER_ID)
		WHERE 1=1
		<if test="pkgId_search != null and pkgId_search != ''">AND PKG_ID = #{pkgId_search}</if>
		<if test="pkgNm_search != null and pkgNm_search != ''">AND PKG_NM LIKE CONCAT('%', #{pkgNm_search}, '%')</if>
		<if test="pkgRegUsrId_search != null and pkgRegUsrId_search != ''">AND REG_USRID = #{pkgRegUsrId_search}</if>
		ORDER BY PKG_ID DESC
		LIMIT #{limit}
		OFFSET #{offset}
	</select>
	
	<!-- package 조회된 개수 조회 -->
	<select id="getPkgCount" parameterType="java.util.HashMap" resultType="int">
		SELECT 
			COUNT(*) AS CNT
		FROM targetai.PKG
		WHERE 1=1
		<if test="pkgId_search != null and pkgId_search != ''">AND PKG_ID = #{pkgId_search}</if>
		<if test="pkgNm_search != null and pkgNm_search != ''">AND PKG_NM LIKE CONCAT('%', #{pkgNm_search}, '%')</if>
		<if test="pkgRegUsrId_search != null and pkgRegUsrId_search != ''">AND REG_USRID = #{pkgRegUsrId_search}</if>
	</select>
	
	<!-- package 상세 조회 -->
	<select id="getPkg" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
			P.PKG_ID,
			P.PKG_NM,
			P.DRL_NM,
			P.DRL_SOURCE,
			P.DIALECT,
			P.PATH,
			P.REG_USRID,
			M.MEMBER_NAME REG_USRNM,
			DATE_FORMAT(P.REG_DT, '%Y-%m-%d %h:%i:%s') AS REG_DT,
			P.PKG_DSC,
			DATE_FORMAT(UDT_DT, '%Y-%m-%d %h:%i:%s') AS UDT_DT,
			P.UDT_USRID,
			M1.MEMBER_NAME UDT_USRNM,
		    (SELECT COUNT(*) FROM targetai.RULE WHERE PKG_ID = P.PKG_ID) AS RULE_COUNT_IN_PKG
		FROM 
			targetai.PKG P
			LEFT JOIN targetai.MEMBER M ON (P.REG_USRID = M.MEMBER_ID)
		    LEFT JOIN targetai.MEMBER M1 ON (P.UDT_USRID = M1.MEMBER_ID)
		WHERE
			PKG_ID = #{pkgId}
	</select>
	
	<!-- package 삭제 -->
	<delete id="deletePkgById" parameterType="java.util.HashMap">
		DELETE FROM targetai.PKG
		WHERE
			PKG_ID IN 
		<foreach collection="pkgIdArr" item="pkgId" separator="," open="(" close=")">
			#{pkgId}
		</foreach>
	</delete>
	
	<!-- PKG_ID에 속한 RULE_ID 조회 -->
	<select id="getRuleIdsByPkgId" parameterType="java.util.HashMap" resultType="string">
		SELECT
			RULE_ID
		FROM
			targetai.RULE
		WHERE
			PKG_ID IN 
		<foreach collection="pkgIdArr" item="pkgId" separator="," open="(" close=")">
			#{pkgId}
		</foreach>
	</select>
	
	<!-- RULE 리스트 조회 -->
	<select id="getRuleList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
			R.RULE_ID,
		    R.RULE_NM,
		    R.NO_LOOP,
		    R.LOCK_ON_ACTIVE,
		    R.AGENDA_GRP,
		    R.SALIENCE,
		    R.EFFECTIVE_DT,
		    R.EXPIRES_DT,
		    R.ENABLED,
		    R.DURATION,
		    R.ATTR_THEN,
		    R.NUM_OF_TGT,
		    R.PKG_ID,
		    R.CAMP_ID,
		    DATE_FORMAT(R.REG_DT, '%Y-%m-%d %h:%i:%s') AS REG_DT,
		    R.REG_USRID,
		    M.MEMBER_NAME REG_USRNM,
		    DATE_FORMAT(R.UDT_DT, '%Y-%m-%d %h:%i:%s') AS UDT_DT,
		    R.UDT_USRID,
		    M1.MEMBER_NAME UDT_USRNM
		FROM 
			targetai.RULE R
			LEFT JOIN targetai.MEMBER M ON (R.REG_USRID = M.MEMBER_ID)
		    LEFT JOIN targetai.MEMBER M1 ON (R.UDT_USRID = M1.MEMBER_ID)
		WHERE PKG_ID = #{pkgId}
		<if test="ruleId_search != null and ruleId_search != ''">AND RULE_ID = #{ruleId_search}</if>
	    <if test="ruleRegUsrId_search != null and ruleRegUsrId_search != ''">AND REG_USRID = #{ruleRegUsrId_search}</if>
	    <if test="ruleNm_search != null and ruleNm_search != ''">AND RULE_NM LIKE CONCAT('%', #{ruleNm_search}, '%')</if>
	    ORDER BY RULE_ID DESC
		LIMIT #{limit}
		OFFSET #{offset}
	</select>
	
	<!-- RULE 조회된 개수 조회 -->
	<select id="getRuleCount"  parameterType="java.util.HashMap" resultType="int">
		SELECT 
			COUNT(*) AS CNT
		FROM targetai.RULE
		WHERE PKG_ID = #{pkgId}
		<if test="ruleId_search != null and ruleId_search != ''">AND RULE_ID = #{ruleId_search}</if>
	    <if test="ruleRegUsrId_search != null and ruleRegUsrId_search != ''">AND REG_USRID = #{ruleRegUsrId_search}</if>
	    <if test="ruleNm_search != null and ruleNm_search != ''">AND RULE_NM LIKE CONCAT('%', #{ruleNm_search}, '%')</if>
	</select>
	
	<!-- RULE 상세 조회 -->
	<select id="getRule" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
			R.RULE_ID,
		    R.RULE_NM,
		    R.NO_LOOP,
		    R.LOCK_ON_ACTIVE,
		    R.AGENDA_GRP,
		    R.SALIENCE,
		    R.EFFECTIVE_DT,
		    R.EXPIRES_DT,
		    R.ENABLED,
		    R.DURATION,
		    R.ATTR_THEN,
		    R.NUM_OF_TGT,
		    R.PKG_ID,
		    R.CAMP_ID,
		    R.TARGET_TYPE,
		    R.REG_DT,
		    R.REG_USRID,
		    R.UDT_DT,
		    R.UDT_USRID
		FROM targetai.RULE R
		WHERE
			R.RULE_ID = #{ruleId}
	</select>
	
	<!-- PKG 이름 중복체크 -->
	<select id="pkgNmCheck" parameterType="java.util.HashMap" resultType="int">
		SELECT 
		    COUNT(*)
		FROM
		    targetai.PKG P
		WHERE
		    P.PKG_NM = #{pkgNm}
		<if test="pkgId != ''">AND P.PKG_ID != #{pkgId}</if>    
	</select>
	
	<!-- PKG 저장 -->
	<insert id="addPkg" parameterType="java.util.HashMap">
		INSERT INTO targetai.PKG (
			PKG_NM,
			PKG_DSC,
			PATH,
			REG_USRID
		) VALUES (
			#{pkgNm},
			#{pkgDsc},
			#{PATH},
			#{REG_USER_ID}
		)
		<selectKey keyProperty="PKG_ID" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<!-- PKG 저장시 DRL 파일명 업데이트 -->
	<update id="updatePkg" parameterType="java.util.HashMap">
		UPDATE targetai.PKG
		SET
			PKG_NM = #{pkgNm},
			PKG_DSC = #{pkgDsc},
			UDT_USRID = #{REG_USER_ID},
			UDT_DT = NOW()
		WHERE
			PKG_ID = #{pkgId}
	</update>
	
	<!-- PKG 저장시 DRL 파일명 업데이트 -->
	<update id="updateDrlFileNm" parameterType="java.util.HashMap">
		UPDATE targetai.PKG
		SET
			DRL_NM = #{drlNm}
		WHERE
			PKG_ID = #{PKG_ID}
	</update>
	
	<!-- 속성 view 리스트 조회 -->
	<select id="getFactorGrpList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			FACTOR_GRP_ID,
			FACTOR_GRP_PID,
			FACTOR_GRP_NM,
		    FACTOR_GRP_DSC,
		    REG_DTM,
		    ATTR_USE_YN
		FROM
		    targetai.FACTOR_GRP
		WHERE
			ATTR_USE_YN = 'Y'
		<if test='functionYn == "N"'>AND FACTOR_GRP_NM != '함수'</if>
	</select>
	
	<!-- 속성 view 하위 요소 리스트 조회 -->
	<select id="getFactorList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			FACTOR_ID,
		    FACTOR_NM,
		    FACTOR_NM_EN,
		    FACTOR_TYPE,
		    DATA_TYPE,
		    NUM_OF_GRP,
		    CATEGORY_YN,
		    FACTOR_GRP_ID,
		    ATTR_USE_YN
		FROM
		    targetai.FACTOR
		WHERE
			ATTR_USE_YN = 'Y'
			AND FACTOR_GRP_ID = #{factorGrpId}
		ORDER BY
			`ORDER` ASC
	</select>
	
	<!-- RULE 이름 중복체크 -->
	<select id="ruleNmCheck" parameterType="java.util.HashMap" resultType="int">
		SELECT 
		    COUNT(*)
		FROM
		    targetai.PKG P, targetai.RULE R
		WHERE
			P.PKG_ID = R.PKG_ID
			AND P.PKG_ID = #{pkgId}
		    AND R.RULE_NM = #{ruleNm}
		    <if test="ruleId != ''">AND R.RULE_ID != #{ruleId}</if>
	</select>
	
	<!-- Factor 조회 -->
	<select id="getFactor" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			FG.FACTOR_GRP_ID,
		    FG.FACTOR_GRP_NM,
		    F.FACTOR_ID,
		    F.FACTOR_NM,
		    F.FACTOR_NM_EN,
		    F.FACTOR_TYPE,
		    F.DATA_TYPE,
		    F.ATTR_USE_YN
		FROM
		    targetai.FACTOR F, targetai.FACTOR_GRP FG
		WHERE
			F.FACTOR_GRP_ID = FG.FACTOR_GRP_ID
		    AND F.ATTR_USE_YN = 'Y'
		    AND F.FACTOR_ID = #{factorId}
	</select>
	
	<!-- Factor Value 조회 -->
	<select id="getFactorVal" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			FG.FACTOR_GRP_ID,
		    FG.FACTOR_GRP_NM,
		    F.FACTOR_ID,
		    F.FACTOR_NM,
		    F.FACTOR_NM_EN,
		    F.FACTOR_TYPE,
		    F.DATA_TYPE,
		    F.ATTR_USE_YN,
		    FV.VAL
		FROM
		    targetai.FACTOR F, targetai.FACTOR_GRP FG, targetai.FACTOR_VAL FV
		WHERE
			F.FACTOR_GRP_ID = FG.FACTOR_GRP_ID
		    AND F.FACTOR_ID = FV.FACTOR_ID
		    AND F.ATTR_USE_YN = 'Y'
		    AND F.DATA_TYPE = 'STRING'
		    AND F.FACTOR_ID = #{factorId}
	</select>
	
	<!-- FACTOR 함수 선택시 ARGUMENT 조회 -->
	<select id="getFactorFuncArgs" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
		    FACTOR_FUNC_ARGS_ID,
		    FACTOR_ID,
		    ARG_NM,
		    `ORDER`,
		    DATA_TYPE,
		    REG_DT
		FROM
		    targetai.FACTOR_FUNC_ARGS
		WHERE
			FACTOR_ID = #{factorId}
		ORDER BY
			`ORDER` ASC
	</select>
	
	<!-- RULE 저장 -->
	<insert id="ruleSave" parameterType="java.util.HashMap">
		INSERT INTO targetai.RULE (
			RULE_NM,
			NO_LOOP,
			LOCK_ON_ACTIVE,
			SALIENCE,
			TARGET_TYPE,
			PKG_ID,
			REG_USRID
		) VALUES (
			#{ruleNm},
			#{noLoop},
			#{lockOnActive},
			#{salience},
			#{targetType},
			#{pkgId},
			#{REG_USER_ID}
		)
		<selectKey keyProperty="RULE_ID" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<!-- RULE ATTR 저장 -->
	<insert id="ruleAttrSave" parameterType="java.util.HashMap">
		INSERT INTO targetai.RULE_ATTR (
			RULE_ID,
			ATTR_WHEN,
			ATTR_WHEN_CONTENTS,
			FACTOR_GRP_NM,
			FACTOR_ID,
			FACTOR_NM,
			FACTOR_NM_EN,
			FACTOR_VAL,
			LOGICAL,
			RELATION
		) VALUES 
		<foreach collection="ruleObjArr" item="ruleAttr" separator=",">
		(
			#{ruleId},
			#{ruleAttr.ruleAttr_source},
			#{ruleAttr.ruleAttr_txt},
			#{ruleAttr.factorGrpNm},
			#{ruleAttr.factorId},
			#{ruleAttr.factorNm},
			#{ruleAttr.factorNmEn},
			#{ruleAttr.factorVal},
			#{ruleAttr.logical_txt},
			#{ruleAttr.relation_txt}
		)
		</foreach>
	</insert>
	
	<!-- RULE 수정 -->
	<update id="ruleUpdate" parameterType="java.util.HashMap">
		UPDATE targetai.RULE
		SET
			RULE_NM = #{ruleNm},
			NO_LOOP = #{noLoop},
			LOCK_ON_ACTIVE = #{lockOnActive},
			SALIENCE = #{salience},
			TARGET_TYPE = #{targetType},
			PKG_ID = #{pkgId},
			UDT_DT = NOW(),
			UDT_USRID = #{USER_ID}
		WHERE
			RULE_ID = #{ruleId}
	</update>
	
	<!-- RULE ATTR 삭제 -->
	<delete id="deleteRuleAttrById" parameterType="java.util.HashMap">
		DELETE FROM targetai.RULE_ATTR
		WHERE RULE_ID = #{ruleId}
	</delete>
	
	<!-- RULE 삭제 -->
	<delete id="deleteRuleById" parameterType="java.util.HashMap">
		DELETE FROM targetai.RULE
		WHERE RULE_ID IN 
		<foreach collection="ruleIdArr" item="ruleId" separator="," open="(" close=")">
			#{ruleId}
		</foreach>
	</delete>
	
	<!-- RULE ATTR 삭제 -->
	<delete id="deleteRuleAttrByIds" parameterType="java.util.HashMap">
		DELETE FROM targetai.RULE_ATTR
		WHERE RULE_ID IN 
		<foreach collection="ruleIdArr" item="ruleId" separator="," open="(" close=")">
			#{ruleId}
		</foreach>
	</delete>
	
	<!-- RULE 의 ATTR_WHEN 업데이트 -->
	<update id="updateAttrThen" parameterType="java.util.HashMap">
		UPDATE targetai.RULE
		SET
			ATTR_THEN = #{ATTR_THEN}
		WHERE
			RULE_ID = #{ruleId}
	</update>
	
	<!-- PKG 정보 조회 -->
	<select id="getPkgById" parameterType="string" resultType="java.util.HashMap">
		SELECT
			PKG_ID,
		    PKG_NM,
		    DRL_NM,
		    DRL_SOURCE,
		    DIALECT,
		    PATH
		FROM
			targetai.PKG
		WHERE
			PKG_ID = #{pkgId}
	</select>
	
	<!-- RULE 정보 조회 -->
	<select id="getRuleListByPkgId" parameterType="string" resultType="java.util.HashMap">
		SELECT
			RULE_ID,
		    RULE_NM,
		    NO_LOOP,
		    LOCK_ON_ACTIVE,
		    AGENDA_GRP,
		    SALIENCE,
		    EFFECTIVE_DT,
		    EXPIRES_DT,
		    ENABLED,
		    DURATION,
		    ATTR_THEN,
		    NUM_OF_TGT,
		    PKG_ID,
		    CAMP_ID,
		    REG_DT
		FROM
			targetai.RULE
		WHERE
			PKG_ID = #{pkgId}
	</select>
	
	<!-- RULE_ATTR 정보 조회 -->
	<select id="getWhenList" parameterType="int" resultType="java.util.HashMap">
		SELECT
			RA.RULE_ATTR_ID,
			RA.RULE_ID,
			RA.ATTR_WHEN,
		    RA.ATTR_WHEN_CONTENTS,
		    RA.FACTOR_GRP_NM,
		    RA.FACTOR_ID,
		    RA.FACTOR_NM,
		    RA.FACTOR_NM_EN,
		    RA.FACTOR_VAL,
		    RA.LOGICAL,
		    RA.RELATION,
		    F.DATA_TYPE
		FROM
			targetai.RULE_ATTR RA
		    LEFT JOIN targetai.FACTOR F ON (RA.FACTOR_ID = F.FACTOR_ID)
		WHERE
			RA.RULE_ID = #{pkgId}
		ORDER BY 
			RULE_ATTR_ID ASC
	</select>
	
	<!-- PKG 의 DRL_SOURCE 업데이트 -->
	<update id="updateDrlSource" parameterType="java.util.HashMap">
		UPDATE targetai.PKG
		SET
			DRL_SOURCE = #{DRL_SOURCE}
		WHERE
			PKG_ID = #{PKG_ID}
	</update>
	
	<!-- RULE TEST OPEN 팝업 내 RULE 속성 -->
	<select id="getRuleAttrByPkgId" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			R.RULE_ID,
			R.RULE_NM,
		    R.SALIENCE,
			RA.FACTOR_GRP_NM,
			RA.FACTOR_NM,
			RA.FACTOR_NM_EN,
			RA.FACTOR_VAL,
			RA.LOGICAL,
			RA.RELATION,
			RA.ATTR_WHEN_CONTENTS
		FROM
			targetai.PKG P
		    LEFT JOIN targetai.RULE R ON (P.PKG_ID = R.PKG_ID)
		    LEFT JOIN targetai.RULE_ATTR RA ON (R.RULE_ID = RA.RULE_ID)
		WHERE
			R.PKG_ID = #{pkgId}
		ORDER BY SALIENCE ASC, RULE_ID ASC, RULE_ATTR_ID ASC
	</select>
</mapper>